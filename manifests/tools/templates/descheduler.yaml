apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: descheduler
  namespace: {{ .Values.metadata.namespace }}
spec:
  destination:
    namespace: kube-system
    server: {{ .Values.spec.destination.server }}
  project: {{ .Values.spec.project }}
  source:
    chart: descheduler
    repoURL: https://kubernetes-sigs.github.io/descheduler
    targetRevision: 0.31.0
    helm:
      valuesObject:
        deschedulerPolicy:
          profiles:
            - name: RemoveDuplicates
              pluginConfig:
              - name: "RemoveDuplicates"
                args:
                  excludeOwnerKinds:
                    - "ReplicaSet"
              plugins:
                balance:
                  enabled:
                    - "RemoveDuplicates"
            - name: RemovePodsHavingTooManyRestarts
              pluginConfig:
              - name: "RemovePodsHavingTooManyRestarts"
                args:
                  podRestartThreshold: 50
                  includingInitContainers: true
              plugins:
                deschedule:
                  enabled:
                    - "RemovePodsHavingTooManyRestarts"
  syncPolicy:
    automated:
      selfHeal: true
      prune: true
