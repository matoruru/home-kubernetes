apiVersion: batch/v1
kind: CronJob
metadata:
  name: reload-docker-images
spec:
  suspend: true
  schedule: "0 0 1 1 *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: reload-images
          initContainers:
          - name: api
            image: matoruru_idobata-api
            imagePullPolicy: Always
            command:
            - /bin/sh
            - -c
            - echo "A fresh docker image for api has been pulled!"
          - name: ui
            image: matoruru_idobata-ui
            imagePullPolicy: Always
            command:
            - /bin/sh
            - -c
            - echo "A fresh docker image for ui has been pulled!"
          containers:
          - name: restart
            image: bitnami/kubectl:latest
            command:
            - /bin/sh
            - -c
            - |
              NAMESPACE=$(cat /var/run/secrets/kubernetes.io/serviceaccount/namespace)
              echo "Restarting Deployment/idobata-api at $(date)"
              kubectl -n "$NAMESPACE" rollout restart deployment idobata-api
              echo "Deployment/idobata-api restarted at $(date)"
              echo "Restarting Deployment/idobata-ui at $(date)"
              kubectl -n "$NAMESPACE" rollout restart deployment idobata-ui
              echo "Deployment/idobata-ui restarted at $(date)"
          restartPolicy: Never
