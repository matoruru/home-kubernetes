apiVersion: batch/v1
kind: CronJob
metadata:
  name: reload-docker-images
spec:
  suspend: true
  schedule: "0 0 1 1 *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: reload-images
          initContainers:
          - name: api
            image: matoruru_idobata-api
            imagePullPolicy: Always # This is necessary to pull the fresh image
            command:
            - /bin/sh
            - -c
            - echo "A fresh docker image for api has been pulled!"
          - name: ui
            image: matoruru_idobata-ui
            imagePullPolicy: Always # This is necessary to pull the fresh image
            command:
            - /bin/sh
            - -c
            - echo "A fresh docker image for ui has been pulled!"
          containers:
          - name: restart
            image: bitnami/kubectl:latest
            imagePullPolicy: IfNotPresent
            command:
            - /bin/sh
            - -c
            - |
              NAMESPACE=$(cat /var/run/secrets/kubernetes.io/serviceaccount/namespace)
              echo "Restarting Deployment/api at $(date)"
              kubectl -n "$NAMESPACE" rollout restart deployment api
              echo "Deployment/api restarted at $(date)"
              echo "Restarting Deployment/ui at $(date)"
              kubectl -n "$NAMESPACE" rollout restart deployment ui
              echo "Deployment/ui restarted at $(date)"
          restartPolicy: Never
